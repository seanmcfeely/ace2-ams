FROM cypress/included:10.3.0

ARG http_proxy
ARG https_proxy
ARG no_proxy
ARG npm_strict_ssl=true

ENV http_proxy=$http_proxy
ENV HTTP_PROXY=$http_proxy
ENV https_proxy=$https_proxy
ENV HTTPS_PROXY=$https_proxy
ENV no_proxy=$no_proxy
ENV NO_PROXY=$no_proxy

RUN apt-get install -y curl

WORKDIR /app

COPY package*.json ./

RUN npm config set strict-ssl ${npm_strict_ssl} && npm install 

# clear proxy settings after we're done using them
ENV http_proxy=
ENV HTTP_PROXY=
ENV https_proxy=
ENV HTTPS_PROXY=
ENV no_proxy=
ENV NO_PROXY=

COPY . .

# Fixes the strange permission issues GitHub Actions was having.
RUN chmod -R 777 /app

# Override the entrypoint of the cypress/included image
ENTRYPOINT ["bash", "-c", "while !</dev/tcp/gui-api/80; do sleep 1; done; npm run dev"]
